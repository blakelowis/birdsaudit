/var/home/blake/Downloads/Birds_Audit.html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Retail Audit (Modular) — Manual Question Upload</title>
  <meta name="theme-color" content="#47b39d"/>
  <style>
    @page { size: landscape; }
    :root{
      --bg:#f6faf8; --card:#ffffff; --ink:#1f2937; --muted:#667085; --border:#e6eae7;
      --brand:#0ea5e9; --accent:#47b39d; --accent2:#10b981; --ring:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-tap-highlight-color:transparent}
    header{position:sticky;top:0;z-index:5;background:#111827;color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    header h1{font-size:18px;margin:0;display:flex;gap:10px;align-items:center}
    .brand-chip{width:28px;height:28px;border-radius:8px;border:1px solid #374151;background:#fff;overflow:hidden;display:grid;place-items:center}
    .brand-chip img{max-width:100%;max-height:100%;display:block}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-left:auto}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;color:#fff;background:var(--accent)}
    .btn.ghost{background:transparent;border:2px solid #fff;color:#fff}
    .btn.green{background:var(--accent2)}
    .btn.small{padding:6px 8px;border-radius:8px}
    .wrap{max-width:1120px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.06);margin-bottom:12px}
    #meta .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    #meta label{display:flex;flex-direction:column;font-size:12px;color:var(--muted)}
    #meta input[type=text],#meta input[type=date]{margin-top:4px;padding:10px;border:1px solid var(--border);border-radius:10px;font-size:14px;background:#fff}
    .scorecard{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
    .donut{width:120px;height:120px}
    .stat{min-width:150px}
    .stat b{font-size:1.25rem}
    .hint{color:var(--muted);font-size:.95rem}
    .tiles{display:grid;gap:10px}
    .tiles.auto{grid-template-columns:repeat(2,1fr)}
    @media (min-width:560px){ .tiles.auto{grid-template-columns:repeat(3,1fr)} }
    @media (min-width:900px){ .tiles.auto{grid-template-columns:repeat(4,1fr)} }
    .tile{background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px;display:flex;flex-direction:column;gap:8px;cursor:pointer}
    .tile:hover{background:#f3f4f6}
    .tile h3{margin:0;font-size:1.05rem}
    .tile p{margin:0;color:#374151;font-size:.95rem}
    .crumbs{display:flex;gap:6px;align-items:center;margin:10px 0}
    .crumbs .crumb{color:#2563eb;cursor:pointer}
    .crumbs .sep{color:#9ca3af}
    .cat{border-top:1px dashed var(--border);padding-top:10px;margin-top:10px}
    .cat:first-child{border-top:none}
    .cat-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .cat-title{font-weight:800}
    .cat-body{margin-top:8px;display:none}
    .cat.open .cat-body{display:block}
    .q{border-top:1px dashed var(--border);padding-top:12px;margin-top:12px}
    .q:first-child{border-top:none}
    .qhead{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .qtitle{font-weight:700;font-size:1rem}
    .answers{display:flex;gap:8px;align-items:center;flex-wrap:wrap;color:#374151}
    .answers label{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 12px;border-radius:999px;cursor:pointer;user-select:none;min-height:40px;font-weight:700}
    .answers input{accent-color:#0ea5e9}
    .photo{display:flex;align-items:center;gap:10px;margin-top:8px}
    .photo label{padding:10px;border:2px dashed var(--border);border-radius:10px;background:#f9fafb;cursor:pointer}
    .photo input{display:none}
    .thumb{width:96px;height:96px;border-radius:8px;border:1px solid var(--border);object-fit:cover;display:none}
    .ap-toggle{display:flex;align-items:center;gap:8px;margin-top:8px}
    .ap-fields{margin-top:8px;background:#f9fafb;border:1px solid var(--border);border-radius:10px;padding:10px;display:none}
    .ap-fields.active{display:block}
    .ap-fields .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .ap-fields label{display:flex;flex-direction:column;font-size:12px;color:var(--muted)}
    .ap-fields input[type=text],.ap-fields input[type=date],.ap-fields select,.ap-fields textarea{
      margin-top:4px;padding:8px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:#fff;color:#000}
    .ap-fields textarea{min-height:64px;resize:vertical}
 .comment{margin-top:8px}
 .comment-box{margin-top:8px;display:none}
 .comment-box.active{display:block}
 .comment-box textarea{width:100%;min-height:64px;resize:vertical;padding:8px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:#fff;color:#000}

    #actionPanel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.06);margin-top:12px}
    #apTable{width:100%;border-collapse:collapse;margin-top:6px}
    #apTable th,#apTable td{border:1px solid var(--border);padding:8px;text-align:left;vertical-align:top}
    #apTable th{background:#f3f4f6}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:#667085}
    .ap-filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:4px}
    body.has-watermark::before{content:"";position:fixed;inset:0;z-index:-1;opacity:.06;background-repeat:no-repeat;background-position:center;background-size:40%}
    .diag{background:#eef2ff;color:#1e3a8a;border:1px solid #c7d2fe;border-radius:10px;padding:8px 12px;margin:8px 0;font-size:.95rem;display:none}
    
.tools { position: relative; z-index: 50; }
.tools .btn { position: relative; z-index: 51; }

</style>
<style>
/* --- Mobile + UI Enhancements v3 --- */
:root{
  --touch: 44px; /* minimum touch target */
  --brand:#0ea5e9;            /* primary accent (links, active) */
  --accent:#47b39d;           /* success/brand */
  --accent2:#10b981;          /* success */
  --danger:#ef4444;
  --ink:#1f2937;
  --muted:#667085;
  --border:#e6eae7;
}

/* Improve base tap sizes and focus visibility */
button, .btn, label, input, select, textarea { 
  min-height: var(--touch);
}
:focus-visible {
  outline: 3px solid var(--brand);
  outline-offset: 2px;
}

/* Header tweaks for smaller screens */
header { gap: 10px; }
header .actions { width: 100%; justify-content: flex-start; }
@media (min-width: 720px){ header .actions{ width: auto; justify-content: flex-end; } }

/* Meta grid responsive */
#meta .grid { grid-template-columns: 1fr; }
@media (min-width: 560px){ #meta .grid { grid-template-columns: repeat(2, minmax(0,1fr)); } }
@media (min-width: 900px){ #meta .grid { grid-template-columns: repeat(4, minmax(0,1fr)); } }
#meta input[type=text],#meta input[type=date]{ font-size:16px; }

/* Segmented answers: bigger, clearer chips */
.answers { gap: 10px; }
.answers input[type="radio"]{ position: absolute; opacity: 0; width:0; height:0; }
.answers label{
  position: relative;
  padding: 10px 14px;
  border-radius: 12px;
  border: 2px solid var(--border);
  background: #fff;
  color: var(--ink);
  transition: background .2s, border-color .2s, box-shadow .2s, transform .02s;
}
.answers label.sel, .answers label:has(input:checked){
  border-color: var(--brand);
  background: linear-gradient(90deg, var(--brand), #60a5fa);
  color: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,.12);
}
.answers label:active{ transform: translateY(1px); }

/* Question cards spacing */
.q { padding-top: 14px; }
.qtitle{ line-height:1.35; }
.photo label{ width: 100%; text-align: center; }
.photo .thumb{ width: 110px; height: 110px; }

/* Category cards: clearer affordance */
.cat-head .btn.ghost{ border-color: var(--border); color: var(--ink); }

/* Sticky mobile bottom action bar */
.mbar{ 
  position: fixed; left: 0; right: 0; bottom: 0; z-index: 40; 
  padding: max(8px, env(safe-area-inset-bottom));
  background: rgba(255,255,255,.98);
  border-top: 1px solid var(--border);
  box-shadow: 0 -4px 16px rgba(0,0,0,.06);
  display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
}
.mbar .btn{ border-radius: 999px; font-weight: 800; }
@media (min-width: 900px){ .mbar{ display: none; } }
body{ padding-bottom: 84px; }

/* Improve table readability */
#apTable th, #apTable td { font-size: 13px; }
#apTable img{ border-radius: 8px; }

/* Better toasts on mobile */
#saveToast{ font-size: 15px; padding: 12px 16px; }

/* High-contrast ghost button outline on hover/focus */
.btn.ghost:hover, .btn.ghost:focus-visible{ border-color: var(--brand); color: var(--brand); }

/* Support dark color scheme if device is dark */
@media (prefers-color-scheme: dark){
  :root{ --bg:#0b1411; --card:#0f1a16; --ink:#f1f5f9; --muted:#9aa4b2; --border:#1f2b25; --ring:#1c2722; }
  body{ background:var(--bg); color:var(--ink); }
  .card, .tile, .meta-card{ background: #0f1a16; border-color: var(--border); }
  .answers label{ background:#0f1a16; }
}
</style>
<link rel="manifest" href="manifest.json">
</head>
<body>
  <div id="errorBanner" role="alert" style="display:none;background:#fee2e2;color:#991b1b;border-bottom:1px solid #fecaca;padding:8px 16px;font-weight:600"></div>
  <header>
    <h1>
      <span class="brand-chip"><img id="hdrLogo" alt="Logo"/></span>
      Retail Audit (Modular)
    </h1>
    <div class="actions">
 <span id="saveStatus" class="pill" aria-live="polite">Saved</span>
      <label class="btn ghost" style="cursor:pointer">
        <input id="logoPicker" type="file" accept="image/*" hidden />
        Brand logo (watermark)
      </label>
<button class='btn ghost build-only' id='saveTemplateBtn'>Save JSON</button>
      <label class="btn ghost" style="cursor:pointer">
        <input id="seedPicker" type="file" accept="application/json" hidden />
        Load Question Set (.json)
      </label>
      <button class="btn ghost" id="saveBtn">Save</button>
      <button class="btn ghost" id="clearBtn">Clear</button>
 <button class="btn ghost build-only" id="btnClearCache">Clear cache</button>
      
      <button class="btn green" id="exportBtn">Export HTML (autosave)</button>
      
      <button class="btn" id="btnExportActionCsv">Export Action Plan (CSV)</button>
      
    </div>
  
<label class="btn ghost" style="cursor:pointer">
  <input id="modeToggle" type="checkbox" hidden />
  <span id="modeLabel">Audit mode</span>
</label>

 </header>

  <div class="wrap">
    <div id="diag" class="diag"></div>

    <!-- Meta -->
    <section id="meta" class="card">
      <div class="grid">
        <label>Store Name<input id="storeName" type="text" placeholder="e.g., Birds Bakery, Derby"></label>
        <label>Auditor<input id="auditorName" type="text" placeholder="Your name"></label>
        <label>Store Manager<input id="storeManager" type="text" placeholder="e.g., Jane Smith"></label>
        <label>Date<input id="auditDate" type="date"></label>
      </div>
      <div class="hint" style="margin-top:8px">Tip: Use <b>Load Question Set (.json)</b> to import the latest question bank.</div>
    </section>

    <!-- Scoreboard -->
    <section class="card">
      <div class="scorecard">
        <svg class="donut" viewBox="0 0 42 42" aria-hidden="true">
          <circle cx="21" cy="21" r="18" fill="transparent" stroke="var(--ring)" stroke-width="6"></circle>
          <circle id="donutVal" cx="21" cy="21" r="18" fill="transparent" stroke="var(--brand)" stroke-width="6"
                  stroke-dasharray="0 113" stroke-linecap="round" transform="rotate(-90 21 21)"></circle>
          <text id="donutText" x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                font-size="8" fill="#111827" font-weight="800">0%</text>
        </svg>
        <div class="stat"><div class="hint">Answered (Pass/Fail)</div><b id="answered">0</b></div>
        <div class="stat"><div class="hint">Open actions</div><b id="openActions">0</b></div>
        <div class="stat"><div class="hint">Overall score</div><b id="scorePct">0%</b></div>
      </div>
    </section>

    <!-- Crumbs -->
    <div class="crumbs" id="crumbs"></div>

    <!-- Main pane -->
    <section class="card" id="pane">
      <div class="hint">No questions loaded. Click <b>Load Question Set (.json)</b> to begin.</div>
    </section>

    <!-- Action Plan summary -->
    <section id="actionPanel" class="card" aria-label="Action Plan">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <h3 style="margin:0;">Action Plan</h3>
        <span class="pill" id="apCount">0 items</span>
        <div class="ap-filters" style="margin-left:auto;">
          <label>Status
            <select id="apFilterStatus">
              <option value="all">All</option>
              <option value="open" selected>Open</option>
              <option value="closed">Closed</option>
            </select>
          </label>
        </div>
      </div>
      <table id="apTable" aria-describedby="apCount">
        <thead>
          <tr>
            <th style="width:18%">Sector / Category</th>
            <th style="width:26%">Description</th>
            <th style="width:14%">Person responsible</th>
            <th style="width:20%">Action needed</th>
            <th style="width:8%">Status</th>
            <th style="width:8%">Closed on</th>
            <th style="width:6%">Photo</th>
          </tr>
        </thead>
        <tbody id="apBody"></tbody>
      </table>
    </section>

    <footer style="margin:12px 0 28px"><div class="hint" id="wmStatus">No watermark set</div></footer>
  </div>

  <div id="saveToast" style="position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(20,20,20,.85);color:#fff;padding:10px 14px;border-radius:999px;font-weight:800;font-size:14px;opacity:0;pointer-events:none;transition:opacity .25s;z-index:9999">Saved ✓</div>

  <script>
  if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('Service Worker registered!'))
      .catch(err => console.log('Service Worker registration failed:', err));
  });
}
  // ===== Utils & diagnostics =====
function exportJSON(){ var data=JSON.stringify(state.sectors,null,2); var blob=new Blob([data],{type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='template.json'; a.click(); }
  var BANNER = document.getElementById('errorBanner');
  function showBanner(msg){ BANNER.textContent = msg; BANNER.style.display = 'block'; }
  window.addEventListener('error', function(ev){ var msg = 'Script error: ' + (ev && (ev.message || (ev.error && ev.error.message)) || 'Unknown'); showBanner(msg); });
  var diag = document.getElementById('diag');
  function uid(){ return Math.random().toString(36).slice(2,9); }
  function $(s){ return document.querySelector(s); }
  function el(t,a,c){ var n=document.createElement(t); a=a||{}; c=c==null?[]:Array.isArray(c)?c:[c]; for(var k in a){ if(k==='class'){n.className=a[k];} else { n.setAttribute(k,a[k]); } } c.forEach(function(ch){ if(ch==null) return; n.append(ch instanceof Node? ch : document.createTextNode(ch)); }); return n; }
  function esc(s){var x=String(s==null?'':s);return x.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;'); }

  // ===== Watermark =====
  function loadWatermark(){ try { return localStorage.getItem('audit_watermark_v2') || null; } catch(e){ return null; } }
  function applyWatermarkToPage(){
    document.body.classList.toggle('has-watermark', !!state.watermark);
    var note = $('#wmStatus');
    if(state.watermark){
      note.textContent='Watermark set (embedded in export & print)';
      var style = document.getElementById('wm-style') || document.createElement('style');
      style.id='wm-style';
      style.textContent = "body.has-watermark::before{background-image:url('"+ state.watermark +"')}";
      document.head.appendChild(style);
    } else {
      note.textContent='No watermark set';
      var s=document.getElementById('wm-style'); if(s) s.remove();
    }
  }

  // ===== Embedded logo (placeholder) =====
  var EMBEDDED_LOGO = 'data:image/svg+xml;utf8,'+ encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><circle fill="#b6d9c8" cx="256" cy="256" r="240"/><text fill="#2b3036" x="256" y="275" font-size="140" font-weight="700" text-anchor="middle">Birds</text></svg>');
  document.getElementById('hdrLogo').src = EMBEDDED_LOGO;

  // ===== State =====
  var WORK_KEY_BASE = 'audit_app_v2_modular';
  var state = { meta:{store:'',date:'',auditor:'',manager:''}, watermark: loadWatermark(), sectors:{} };
 // Build mode toggle (UI only)
 var BUILD_MODE = false;

  // ===== Navigation & rendering =====
  var nav = { level:'sectors', sectorId:null, categoryId:null };

  function render(){
    $('#storeName').value = state.meta.store || '';
    $('#auditDate').value = state.meta.date || '';
    $('#auditorName').value = state.meta.auditor || '';
    $('#storeManager').value = state.meta.manager || '';
    renderCrumbs();
    if(Object.keys(state.sectors||{}).length===0){
      var pane=$('#pane'); pane.innerHTML='';
      pane.appendChild(el('div',{class:'hint'},['No questions loaded. Click ', el('b',{},['Load Question Set (.json)']), ' to begin.']));
    }else{
      if(nav.level==='sectors') renderSectors();
      else if(nav.level==='categories') renderCategories(nav.sectorId);
      else if(nav.level==='questions') renderQuestions(nav.sectorId, nav.categoryId);
    }
    applyWatermarkToPage(); applyBuildModeUI();
    updateOverallScore(); updateFloatingScore();
    renderActionPlan(); updateFloatingScore();
  }
  function renderCrumbs(){
    var c = $('#crumbs'); c.innerHTML='';
    var root = el('span', {'class':'crumb'}, ['Sectors']);
    root.addEventListener('click', function(){ nav={level:'sectors',sectorId:null,categoryId:null}; render(); }); c.appendChild(root);
    if(nav.level!=='sectors' && nav.sectorId){ c.appendChild(el('span', {'class':'sep'}, ['›'])); var sec=getSector(nav.sectorId); var s=el('span', {'class':'crumb'}, [sec.title]); s.addEventListener('click', function(){ nav={level:'categories',sectorId:nav.sectorId,categoryId:null}; render(); }); c.appendChild(s); }
    if(nav.level==='questions'){ c.appendChild(el('span', {'class':'sep'}, ['›'])); var cat=getCategory(nav.sectorId, nav.categoryId); c.appendChild(el('span', {}, [cat.name])); }
  }
  function renderSectors(){
    var pane = $('#pane'); pane.innerHTML='';
    var tiles = el('div', {'class':'tiles auto'});
    for(var id in state.sectors){ var sec=state.sectors[id]; var counts=tallySector(id);
      var t=el('div', {'class':'tile', role:'button', 'aria-label':sec.title}, [ el('h3',{},[sec.title]), el('p',{},['Answered: '+counts.answered+' • Open actions: '+counts.open+' • Score: '+counts.pct+'%']) ]);
      (function(id){ t.addEventListener('click', function(){ nav={level:'categories', sectorId:id, categoryId:null}; render(); }); })(id);
      tiles.appendChild(t);
    }
    pane.appendChild(tiles);
  }
  function renderCategories(sectorId){
    var pane=$('#pane'); pane.innerHTML='';
    var sec=getSector(sectorId);
    var controls=el('div',{});
    var btnExpand = el('button',{'class':'btn ghost',type:'button'},['Expand all']);
    var btnCollapse= el('button',{'class':'btn ghost',type:'button'},['Collapse all']);
    controls.style.marginBottom='8px'; controls.style.display='flex'; controls.style.gap='8px';
    controls.appendChild(btnExpand); controls.appendChild(btnCollapse); pane.appendChild(controls);
    var list = el('div',{});
    (sec.categories||[]).forEach(function(cat){
      var box=el('div',{'class':'cat open'});
      var title=el('div',{'class':'cat-title',contenteditable:'true',spellcheck:'false'},[cat.name]);
      title.addEventListener('input', function(){ cat.name=title.textContent; quickSave(); renderActionPlan(); updateFloatingScore(); });
      var head=el('div',{'class':'cat-head'},[title, el('button',{'class':'btn ghost',type:'button'},['Collapse'])]);
      var body=el('div',{'class':'cat-body'}); head.lastChild.addEventListener('click', function(){ if(box.classList.contains('open')){ box.classList.remove('open'); head.lastChild.textContent='Expand'; body.style.display='none'; } else { box.classList.add('open'); head.lastChild.textContent='Collapse'; body.style.display='block'; } }); body.style.display='block';
      (cat.questions||[]).forEach(function(qn){ body.appendChild(renderQuestion(qn)); });
      box.appendChild(head); box.appendChild(body); list.appendChild(box);
    });
    pane.appendChild(list);
    btnExpand.addEventListener('click', function(){ list.querySelectorAll('.cat').forEach(function(box){ var b=box.querySelector('.cat-body'); var t=box.querySelector('.btn.ghost'); box.classList.add('open'); if(b) b.style.display='block'; if(t) t.textContent='Collapse'; }); });
    btnCollapse.addEventListener('click', function(){ list.querySelectorAll('.cat').forEach(function(box){ var b=box.querySelector('.cat-body'); var t=box.querySelector('.btn.ghost'); box.classList.remove('open'); if(b) b.style.display='none'; if(t) t.textContent='Expand'; }); });
  }
  function renderQuestions(sectorId, categoryId){
    var pane=$('#pane'); pane.innerHTML='';
    var cat=getCategory(sectorId, categoryId);
    var box=el('div',{'class':'cat open'});
    var head=el('div',{'class':'cat-head'},[ el('div',{'class':'cat-title'},[cat.name]), el('button',{'class':'btn ghost',type:'button'},['Collapse']) ]);
    var body=el('div',{'class':'cat-body'}); head.lastChild.addEventListener('click', function(){ if(box.classList.contains('open')){ box.classList.remove('open'); head.lastChild.textContent='Expand'; } else { box.classList.add('open'); head.lastChild.textContent='Collapse'; } }); body.style.display='block';
    (cat.questions||[]).forEach(function(qn){ body.appendChild(renderQuestion(qn)); });
    box.appendChild(head); box.appendChild(body); pane.appendChild(box);
  }

  // ---- Question row ----
  function renderQuestion(qn){
    var wrap=el('div',{'class':'q','data-id':qn.id || (qn.id=uid())});
    var title=el('div',{'class':'qtitle', spellcheck:'false'},[qn.text]); if(BUILD_MODE){ title.setAttribute('contenteditable','true'); }
    title.addEventListener('input', function(){ if(!BUILD_MODE) return; qn.text = title.textContent; quickSave(); renderActionPlan(); updateFloatingScore(); });
    var head=el('div',{'class':'qhead'},[ title, el('div',{'class':'answers'},[ ansChip(qn,'Pass'), ansChip(qn,'Fail'), ansChip(qn,'NA') ]) ]);

// -- Build Mode: Weight UI (UI only; scoring unchanged in Step 1)
(function(){
  var weightWrap = el('div', {style:'display:flex;align-items:center;gap:6px;'});
  var weightLbl  = el('span', {class:'pill'}, ['Weight']);
  var weightInp  = el('input', {type:'number', min:'1', max:'10', value:String(qn.weight||1),
                                 style:'width:64px;padding:6px;border:1px solid var(--border);border-radius:8px;'});
  weightInp.addEventListener('input', function(){
    var v=parseInt(this.value,10); qn.weight=(isNaN(v)||v<1)?1:v; quickSave();
  });
  if(!BUILD_MODE) weightWrap.style.display='none';
  weightWrap.appendChild(weightLbl);
  weightWrap.appendChild(weightInp);
  head.appendChild(weightWrap);
})();

    wrap.appendChild(head);
    // Photo
    var ph=el('div',{'class':'photo'});
    var lab=el('label',{},['Add photo']);
    var inp=el('input',{}); inp.type='file'; inp.accept='image/*'; inp.capture='environment';
    var img=el('img',{'class':'thumb','id':'thumb_'+qn.id});
    lab.appendChild(inp); ph.appendChild(lab); ph.appendChild(img);
    inp.addEventListener('change', function(e){ var f=e.target.files && e.target.files[0]; if(!f) return; (async function(){ try{ var data=await readFileAsDataURL(f); var thumb=await makeThumb(data,72,'image/jpeg',0.5); qn.photo=data; qn.photoThumb=thumb; img.src=thumb; img.style.display='block'; }catch(err){ var fr=new FileReader(); fr.onload=function(){ qn.photo=fr.result; img.src=fr.result; img.style.display='block'; }; fr.readAsDataURL(f); } quickSave(); renderActionPlan(); updateFloatingScore(); 
var p=document.getElementById('btnPrint'); if(p){ p.addEventListener('click', function(){ window.print(); }); }
})(); });
    wrap.appendChild(ph);
 // Comment (general, separate from Action Plan)
 var cWrap = el('div', { 'class':'comment' });
 var cBtn = el('button', { 'class':'btn small', type:'button' }, [ (qn.comment && qn.comment.trim()) ? 'Hide comment' : 'Add comment' ]);
 var cBox = el('div', { 'class':'comment-box' + ((qn.comment && qn.comment.trim()) ? ' active' : '') });
 cBox.innerHTML = '<textarea class="q-comment" placeholder="Add a general comment (not part of the Action Plan)"></textarea>';
 if(qn.comment){ cBox.querySelector('.q-comment').value = qn.comment; }
 cBtn.addEventListener('click', function(){ var open = cBox.classList.toggle('active'); cBtn.textContent = open ? 'Hide comment' : 'Add comment'; });
 cBox.addEventListener('input', function(){ qn.comment = cBox.querySelector('.q-comment').value; quickSave(); });
 cWrap.appendChild(cBtn); cWrap.appendChild(cBox);

// ---- Additional evidence (collapsible, 1 photo only)
(function(){
  var evBtn = el('button',{style:'display:none'},'');
  var evBox = el('div', { 'class':'comment-box', 'style':'display:none' });
  // Photo UI (single)
  var evPhotoLabel = el('label', {}, ['Add evidence photo']); evPhotoLabel.style.cursor='pointer';
  var evInput = el('input', {}); evInput.type='file'; evInput.accept='image/*'; evInput.style.display='none';
  evPhotoLabel.addEventListener('click', function(){ evInput.click(); });
  var evImg = el('img', { 'class':'thumb' }); evImg.style.display = (qn.extraPhotoThumb ? 'block':'none'); if(qn.extraPhotoThumb){ evImg.src = qn.extraPhotoThumb; }
  var evComment = el('textarea', { 'class':'q-comment', placeholder:'Extra evidence comment (optional)' }); if(qn.extraComment){ evComment.value = qn.extraComment; }
  evBox.appendChild(evPhotoLabel); evBox.appendChild(evInput); evBox.appendChild(evImg); evBox.appendChild(evComment);

  evBtn.addEventListener('click', function(){ var open = evBox.classList.toggle('active'); evBtn.textContent = open ? 'Hide additional evidence' : 'Additional evidence'; });

  evInput.addEventListener('change', async function(e){ var f=e.target.files && e.target.files[0]; if(!f) return; try{ var data=await readFileAsDataURL(f); var th=await makeThumb(data,72,'image/jpeg',0.5); qn.extraPhoto=data; qn.extraPhotoThumb=th; evImg.src=th; evImg.style.display='block'; quickSave(); }catch(err){ var fr=new FileReader(); fr.onload=function(){ qn.extraPhoto=fr.result; qn.extraPhotoThumb=null; evImg.src=fr.result; evImg.style.display='block'; quickSave(); }; fr.readAsDataURL(f); }
  });

  evComment.addEventListener('input', function(){ qn.extraComment = evComment.value; quickSave(); });

  cWrap.appendChild(evBtn); cWrap.appendChild(evBox);
})();

 wrap.appendChild(cWrap);

    // Action plan
    var apToggle=el('div',{'class':'ap-toggle'});
    var apBtn=el('button',{'class':'btn small',type:'button'},[ (qn.action && qn.action.enabled) ? 'Remove from Action Plan' : 'Add to Action Plan' ]);
    apToggle.appendChild(apBtn); wrap.appendChild(apToggle);
    var apFields=el('div',{'class':'ap-fields'+((qn.action && qn.action.enabled)?' active':'')});
    apFields.innerHTML = (
  ['<div class="grid">',
   '  <label>Description <textarea class="ap-desc" placeholder="Describe the issue"></textarea></label>',
   '  <label>Person responsible <input type="text" class="ap-person" placeholder="Name"></label>',
   '  <label>Action needed <textarea class="ap-action" placeholder="A sentence or two describing the action"></textarea></label>',
   '</div>',
   '<div class="grid">',
   '  <label>Status <select class="ap-status"><option>Open</option><option>Closed</option></select></label>',
   '  <label>Closed on <input type="date" class="ap-closedOn" disabled title="Auto-filled when status = Closed"></label>',
   '  <div></div>',
   '</div>']
).join('');
    wrap.appendChild(apFields);
    if(qn.action && qn.action.enabled){ apFields.querySelector('.ap-desc').value = qn.action.description || ''; apFields.querySelector('.ap-person').value = qn.action.person || ''; apFields.querySelector('.ap-action').value = qn.action.actionNeeded || ''; apFields.querySelector('.ap-status').value = qn.action.status || 'Open'; apFields.querySelector('.ap-closedOn').value = qn.action.closedOn || ''; }
    apBtn.addEventListener('click', function(){ var now=new Date().toISOString(); qn.action = qn.action || {enabled:false,description:'',person:'',actionNeeded:'',status:'Open',closedOn:'',createdAt:now,updatedAt:now}; qn.action.enabled = !qn.action.enabled; qn.action.updatedAt = now; if(qn.action.enabled){ apBtn.textContent='Remove from Action Plan'; apFields.classList.add('active'); } else { apBtn.textContent='Add to Action Plan'; apFields.classList.remove('active'); } updateOverallScore(); updateFloatingScore(); quickSave(); renderActionPlan(); updateFloatingScore(); });
    apFields.addEventListener('input', function(){ var now=new Date().toISOString(); if(!qn.action) qn.action={enabled:true,description:'',person:'',actionNeeded:'',status:'Open',closedOn:'',createdAt:now,updatedAt:now}; var prev=qn.action.status; qn.action.enabled=true; qn.action.description=apFields.querySelector('.ap-desc').value||''; qn.action.person=apFields.querySelector('.ap-person').value||''; qn.action.actionNeeded=apFields.querySelector('.ap-action').value||''; qn.action.status=apFields.querySelector('.ap-status').value||'Open'; if(prev!==qn.action.status){ if(qn.action.status==='Closed'&&!qn.action.closedOn){ qn.action.closedOn=(new Date()).toISOString().slice(0,10);} if(qn.action.status==='Open'){ qn.action.closedOn=''; } apFields.querySelector('.ap-closedOn').value=qn.action.closedOn||''; } updateOverallScore(); updateFloatingScore(); quickSave(); renderActionPlan(); updateFloatingScore(); });
    return wrap;
  }

  function ansChip(qn, type){ var lab=el('label',{},[ el('input',{type:'radio',name:'ans_'+qn.id,value:type,checked:(qn.answer===type ? '' : null)}), type ]); lab.querySelector('input').addEventListener('change', function(){ qn.answer=type; updateOverallScore(); updateFloatingScore(); quickSave(); renderActionPlan(); updateFloatingScore(); }); return lab; }

  // ---- Helpers ----
  function readFileAsDataURL(file){ return new Promise(function(res,rej){ var fr=new FileReader(); fr.onload=function(){res(fr.result)}; fr.onerror=rej; fr.readAsDataURL(file); }); }
  function loadImage(src){ return new Promise(function(res,rej){ var i=new Image(); i.onload=function(){res(i)}; i.onerror=rej; i.src=src; }); }
  function createSquareCanvas(w,h,size){ var _w=size,_h=Math.round(size*(h/w)); if(h>w){ _h=size; _w=Math.round(size*(w/h)); } var c=document.createElement('canvas'); c.width=size; c.height=size; c._w=_w; c._h=_h; var ctx=c.getContext('2d'); ctx.imageSmoothingQuality='high'; ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,size,size); return {canvas:c, ctx:ctx}; }
  async function makeThumb(dataURL,size,mime,quality){ size=size||96; mime=mime||'image/jpeg'; quality=quality||0.6; var img=await loadImage(dataURL); var o=createSquareCanvas(img.width,img.height,size); o.ctx.drawImage(img,(size-o.canvas._w)/2,(size-o.canvas._h)/2,o.canvas._w,o.canvas._h); return o.canvas.toDataURL(mime,quality); }

  
// ===== Pro helpers (no unanswered filter/warning) =====
function isAnswered(q){ return q.answer==='Pass' || q.answer==='Fail' || q.answer==='NA'; }
function setSaveStatus(mode){ var el=document.getElementById('saveStatus'); if(!el) return; el.classList.remove('saving','error'); if(mode==='saving'){ el.textContent='Saving…'; el.classList.add('saving'); } else if(mode==='error'){ el.textContent='Not saved'; el.classList.add('error'); } else { el.textContent='Saved'; } }
function updateFloatingScore(){ try{ var pct=document.getElementById('scorePct').textContent.replace('%','')||'0'; var open=document.getElementById('openActions').textContent||'0'; var b=document.getElementById('floatingScore'); if(!b) return; b.textContent='Score: '+pct+'% • Actions: '+open; b.style.display='block'; }catch(_){} }
function buildSectorDrawer(){ var host=document.getElementById('sectorDrawerList'); if(!host) return; host.innerHTML=''; for(var sid in state.sectors){ var sec=state.sectors[sid]; var t=tallySector(sid); var card=el('div',{'class':'drawer-card'}); card.appendChild(el('div',{'class':'t'},[sec.title])); card.appendChild(el('div',{'class':'m'},['Answered: '+t.answered+' • Open actions: '+t.open+' • Score: '+t.pct+'%'])); (function(s){ card.addEventListener('click', function(){ nav={level:'categories',sectorId:s,categoryId:null}; closeDrawer(); render(); }); })(sid); host.appendChild(card);} }
function openDrawer(){ var d=document.getElementById('sectorDrawer'); if(!d) return; buildSectorDrawer(); d.style.bottom='0'; }
function closeDrawer(){ var d=document.getElementById('sectorDrawer'); if(!d) return; d.style.bottom='-70vh'; }
(function(){ var sx=0, sy=0, t0=0; document.addEventListener('touchstart', function(e){ var t=e.touches&&e.touches[0]; if(!t) return; sx=t.clientX; sy=t.clientY; t0=Date.now(); }, {passive:true}); document.addEventListener('touchend', function(e){ var t=e.changedTouches&&e.changedTouches[0]; if(!t) return; var dx=t.clientX-sx, dy=Math.abs(t.clientY-sy), dt=Date.now()-t0; if(sx<=24 && dx>60 && dy<40 && dt<600){ if(nav.level==='questions'){ nav={level:'categories',sectorId:nav.sectorId,categoryId:null}; render(); } else if(nav.level==='categories'){ nav={level:'sectors',sectorId:null,categoryId:null}; render(); } } }, {passive:true}); })();
// Build-mode toggler for header controls (+ text edit gating hooks below)
function applyBuildModeUI(){ try{ document.querySelectorAll('.build-only').forEach(function(el){ el.style.display = BUILD_MODE ? '' : 'none'; }); var lab=document.getElementById('modeLabel'); if(lab) lab.textContent = BUILD_MODE ? 'Build mode' : 'Audit mode'; }catch(e){} }

// ===== Lookups & scoring =====
  function getSector(id){ return state.sectors[id]; }
  function getCategory(sectorId,categoryId){ var cats=state.sectors[sectorId].categories; for(var i=0;i<cats.length;i++){ if(cats[i].id===categoryId) return cats[i]; } return null; }
  function tallyCategory(sectorId,categoryId){ var cat=getCategory(sectorId,categoryId); var answeredQs=0, openActs=0, scored=0; (cat.questions||[]).forEach(function(q){ var isAns=(q.answer==='Pass'||q.answer==='Fail'); if(isAns){ answeredQs++; var a=q.action&&q.action.enabled?q.action:null; var hasOpen=!!(a&&a.status==='Open'); if(!hasOpen && ((q.answer==='Pass') || (q.answer==='Fail' && a && a.status==='Closed'))){ scored++; } } if(q.action && q.action.enabled && q.action.status==='Open') openActs++; }); var pct=answeredQs? Math.round((scored/answeredQs)*100) : 0; return {answered:answeredQs, open:openActs, scored:scored, pct:pct}; }
  function tallySector(id){ var sec=state.sectors[id]; var answered=0, open=0, scored=0; (sec.categories||[]).forEach(function(cat){ var t=tallyCategory(id,cat.id); answered+=t.answered; open+=t.open; scored+=t.scored; }); var pct=answered? Math.round((scored/answered)*100) : 0; return {answered:answered, open:open, scored:scored, pct:pct}; }
  function updateOverallScore(){ var ids=Object.keys(state.sectors||{}); var eligible=ids.filter(function(i){ return tallySector(i).answered>0; }); var answered=0, open=0, scored=0; eligible.forEach(function(id){ var t=tallySector(id); answered+=t.answered; open+=t.open; scored+=t.scored; }); var pct=answered? Math.round((scored/answered)*100):0; $('#answered').textContent=answered; $('#openActions').textContent=open; $('#scorePct').textContent=pct+'%'; var C=2*Math.PI*18, val=(pct/100)*C; $('#donutVal').setAttribute('stroke-dasharray', val.toFixed(1)+' '+C.toFixed(1)); $('#donutText').textContent=pct+'%'; }

  // ===== Action Plan (render + CSV) =====
  function getActionItems(){ var items=[]; for(var sid in state.sectors){ var sec=state.sectors[sid]; (sec.categories||[]).forEach(function(cat){ (cat.questions||[]).forEach(function(q){ if(q.action && q.action.enabled){ items.push({ sector:sec.title, category:cat.name, id:q.id, text:q.text, action:q.action, photo:q.photo, photoThumb:q.photoThumb, answer:q.answer }); } }); }); } return items; }
  function renderActionPlan(){ var body=$('#apBody'); if(!body) return; body.innerHTML=''; var statusFilter=($('#apFilterStatus')&&$('#apFilterStatus').value)||'open'; var items=getActionItems(); if(statusFilter!=='all'){ items=items.filter(function(a){ return String((a.action&&a.action.status)||'Open').toLowerCase()===statusFilter; }); } $('#apCount').textContent=items.length+' item'+(items.length===1?'':'s'); items.forEach(function(a){ var tr=document.createElement('tr'); tr.innerHTML='<td>'+esc(a.sector)+' / '+esc(a.category)+'</td>' + '<td>'+esc((a.action&&a.action.description)||'')+'</td>' + '<td>'+esc((a.action&&a.action.person)||'')+'</td>' + '<td>'+esc((a.action&&a.action.actionNeeded)||'')+'</td>' + '<td>'+esc((a.action&&a.action.status)||'')+'</td>' + '<td>'+esc((a.action&&a.action.closedOn)||'')+'</td>' + '<td>'+ (a.photoThumb ? '<img src="'+a.photoThumb+'" width="40" height="40" style="border-radius:6px;border:1px solid var(--border);object-fit:cover">' : (a.photo ? 'Yes' : '') ) +'</td>'; body.appendChild(tr); }); }
  function exportActionCSV(){ var hdr=['StoreName','Auditor','Manager','Date','Sector','Category','QuestionID','Question','Description','PersonResponsible','ActionNeeded','Status','ClosedOn','Answer','PhotoIncluded']; var lines=[hdr.join(',')]; var store=$('#storeName').value.trim(), aud=$('#auditorName').value.trim(), man=$('#storeManager').value.trim(), d=$('#auditDate').value || new Date().toISOString().slice(0,10); getActionItems().forEach(function(a){ function q(s){ return '"'+String(s==null?'':s).replace(/"/g,'""').replace(/\n/g,' ')+'"'; } lines.push([q(store),q(aud),q(man),q(d),q(a.sector),q(a.category),a.id,q(a.text),q(a.action.description),q(a.action.person),q(a.action.actionNeeded),q(a.action.status),q(a.action.closedOn),q(a.answer), a.photo?'TRUE':'' ].join(',')); }); download(lines.join('\n'), 'action-plan_'+safeName(store)+'_'+(d||'date')+'.csv', 'text/csv;charset=utf-8'); }

  // ===== Export HTML (autosave inside export) =====
  
function exportHTML(){
  // Meta
  state.meta.store=$('#storeName').value.trim();
  state.meta.date=$('#auditDate').value||new Date().toISOString().slice(0,10);
  state.meta.auditor=$('#auditorName').value.trim();
  state.meta.manager=$('#storeManager').value.trim();

  // Build runtime payload
  var runtimeItems=[]; var answeredBySector=new Map();
  for(var sid in state.sectors){ var sec=state.sectors[sid];
    (sec.categories||[]).forEach(function(cat){ (cat.questions||[]).forEach(function(q){
      var answered=(q.answer==='Pass'||q.answer==='Fail');
      var a=(q.action&&q.action.enabled)?q.action:null;
      var hasComment=((q.comment||'').trim().length>0);
      if(answered){
        runtimeItems.push({ id:q.id, sector:sec.title, category:cat.name, text:q.text, answer:q.answer,
          apEnabled: !!a, apStatus:a?a.status:'Open', apDesc:a?a.description:'', apPerson:a?a.person:'',
          apAction:a?a.actionNeeded:'', apClosedOn:a?a.closedOn:'', photoThumb:q.photoThumb||'',
          apComment:(q.comment||''), apHowClosed:a&&a.howClosed?a.howClosed:'' , extraPhotoThumb:(q.extraPhotoThumb||''), extraComment:(q.extraComment||'')});
      } else if(a){
        runtimeItems.push({ id:q.id, sector:sec.title, category:cat.name, text:q.text, answer:'NA', apEnabled:true,
          apStatus:(q.action.status||'Open'), apDesc:(q.action.description||''), apPerson:(q.action.person||''),
          apAction:(q.action.actionNeeded||''), apClosedOn:(q.action.closedOn||''), photoThumb:(q.photoThumb||''),
          apComment:(q.comment||''), apHowClosed:(q.action.howClosed||'') , extraPhotoThumb:(q.extraPhotoThumb||''), extraComment:(q.extraComment||'')});
      } else if(hasComment){
        runtimeItems.push({ id:q.id, sector:sec.title, category:cat.name, text:q.text, answer:'NA', apEnabled:false,
          apStatus:'Open', apDesc:'', apPerson:'', apAction:'', apClosedOn:'', photoThumb:(q.photoThumb||''),
          apComment:(q.comment||''), apHowClosed:'' , extraPhotoThumb:(q.extraPhotoThumb||''), extraComment:(q.extraComment||'')});
      }
      // Only push answered questions that have neither AP nor comment
      if(answered && !a && !hasComment){
        if(!answeredBySector.has(sec.title)) answeredBySector.set(sec.title,new Map());
        var byCat=answeredBySector.get(sec.title);
        if(!byCat.has(cat.name)) byCat.set(cat.name,[]);
        byCat.get(cat.name).push({text:q.text, answer:q.answer, photo:q.photo||null});
      }
    }); });
  }

  // Escaper
  function h(s){ var x=String(s==null?'':s); return x.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;'); }

  // Build Answered (no AP, no comment)
  var allQHtml='';
  if(answeredBySector.size){
    answeredBySector.forEach(function(cats,sector){
      allQHtml += '<h3 style="margin:12px 0">'+h(sector)+'</h3>' +
                  '<div class="bar"><div class="bar__fill" style="width:0%"></div></div>';
      cats.forEach(function(rows,cat){
        allQHtml += '<h4 style="margin:8px 0 4px">'+h(cat)+'</h4>'+
                    '<table style="border-collapse:collapse;width:100%">'+
                    '<thead><tr><th style="width:60%">Question</th><th style="width:12%">Answer</th><th style="width:28%">Photo</th></tr></thead><tbody>';
        rows.forEach(function(r){
          allQHtml += '<tr><td>'+h(r.text)+'</td><td>'+h(r.answer)+'</td><td>'+(r.photo?'<img class="thumb" src="'+r.photo+'" alt="Photo">':'')+'</td></tr>';
        });
        allQHtml += '</tbody></table>';
      });
    });
  } else {
    allQHtml = '<div class="meta" style="color:#667085">No answered questions to display.</div>';
  }

  var DATA_JSON = safeScriptJSON(runtimeItems);
  var logo = state.watermark || EMBEDDED_LOGO;
  var d=state.meta.date, store=state.meta.store, aud=state.meta.auditor, man=state.meta.manager;
  function __slug(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
  var storageKey='birds_export_'+__slug(store)+'_'+__slug(d)+'_'+(Date.now().toString(36));

  // Template literal export
  var html = `<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Retail Audit Report</title>
<style>
:root{ --bg:#f6faf8; --card:#ffffff; --ink:#2b3036; --muted:#667085; --border:#e6eae7; --accent:#47b39d; --accent2:#10b981; }
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1100px;margin:0 auto;padding:20px}.wm{position:fixed;top:25%;left:50%;transform:translateX(-50%);opacity:.06;z-index:0}.wm img{width:72vh;max-width:90%}
.cover{min-height:100vh;display:grid;align-content:center;gap:18px;padding:28px 16px}.cover__panel{background:linear-gradient(135deg,#ffffff,#eaf5f1);border:1px solid var(--border);border-radius:20px;padding:24px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
.brand{display:flex;align-items:center;gap:14px;margin-bottom:10px}.brand__logo{width:60px;height:60px;border-radius:14px;border:1px solid var(--border);background:#fff;display:grid;place-items:center;overflow:hidden}
.brand__logo img{max-width:100%;max-height:100%}.title{font-size:28px;font-weight:800;margin:0;color:#2b3036}.sub{color:#667085}
.score{display:flex;align-items:baseline;gap:10px;margin-top:10px}.score__pct{font-size:72px;font-weight:900;letter-spacing:-2px;background:linear-gradient(90deg,#47b39d,#10b981);-webkit-background-clip:text;background-clip:text;color:transparent}.score__band{font-size:18px;font-weight:800}
.meta-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:10px}.meta-card{border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px}
.tiles{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px}.tile{border:1px solid var(--border);background:#fff;border-radius:12px;padding:12px}
.pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;color:#667085}
.cover-ap{margin-top:14px;border-top:1px solid var(--border);padding-top:12px}.cover-ap table{border-collapse:collapse;width:100%;margin-top:6px}.cover-ap th,.cover-ap td{border:1px solid var(--border);padding:8px;vertical-align:top}.cover-ap th{text-align:left;background:#f9fcfb}
.bar{background:#eef7f5;border:1px solid var(--border);height:8px;border-radius:999px;overflow:hidden}.bar__fill{height:100%;background:linear-gradient(90deg,#47b39d,#10b981)}.thumb{max-width:110px;border-radius:8px;border:1px solid var(--border);display:block}
.meta{color:#667085}.tools{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}.tools .btn{appearance:none;border:none;border-radius:999px;padding:10px 14px;font-weight:800;background:linear-gradient(90deg,#47b39d,#10b981);color:#fff;cursor:pointer}#allQ{display:none}@media print{body{background:#fff}.tools{display:none}}
.ap-cards{display:grid;gap:12px;grid-template-columns:1fr}.ap-card{border:1px solid var(--border);background:#fff;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.06);padding:12px}
.ap-card__head{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}.ap-head__left{display:flex;flex-direction:column;gap:4px}.ap-card__cat{font-size:12px;color:#667085}.ap-card__q{font-weight:800;line-height:1.35}
.ap-card__body{display:grid;gap:10px;grid-template-columns:1fr}.ap-field .ap-label{font-size:12px;color:#667085;margin-bottom:2px}.ap-val{white-space:pre-wrap}
.apx-toggle{appearance:none;border:none;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer}.apx-toggle.open{background:#e0f2fe;color:#0369a1}.apx-toggle.closed{background:#dcfce7;color:#065f46}
.ap-thumb{width:96px;height:96px;object-fit:cover;border:1px solid var(--border);border-radius:8px;margin-left:12px;flex:0 0 auto}
/* Comment cards */.c-cards{display:grid;gap:12px;grid-template-columns:1fr}.c-card{border:1px solid var(--border);background:#fff;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.06);padding:12px}.c-card__head{font-weight:800;margin-bottom:6px}.c-card__q{font-weight:700}

.tools { position: relative; z-index: 50; }
.tools .btn { position: relative; z-index: 51; }


<style>
.cat-head{ position: sticky; top: 56px; z-index: 9; background: var(--card); border-bottom: 1px dashed var(--border); }
@media (max-width: 560px){ .answers{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; } .answers label{ justify-content:center; width:100%; } }
.answers label{ padding:12px 16px; }
.badge{ display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:12px; color:#374151; background:#fff; }
.badge.ap{ border-color:#f59e0b; color:#92400e; background:#fffbeb; }
.badge.pic{ border-color:#60a5fa; color:#1e40af; background:#eff6ff; }
.badge.cmt{ border-color:#86efac; color:#065f46; background:#ecfdf5; }
.q.collapsed .photo, .q.collapsed .comment, .q.collapsed .ap-fields, .q.collapsed .ap-toggle{ display:none !important; }
.q.collapsed{ opacity:.9; }
.drawer-card{ border:1px solid var(--border); border-radius:12px; padding:10px; background:#fff; display:flex; flex-direction:column; gap:4px }
.drawer-card .t{ font-weight:800 }
.drawer-card .m{ color:#667085; font-size:12px }
.spinner{ width:18px; height:18px; border-radius:50%; border:2px solid #d1d5db; border-top-color:#0ea5e9; animation:spin .8s linear infinite; display:inline-block }
@keyframes spin{to{ transform:rotate(360deg); }}
#saveStatus{ background:#eef2ff; border-color:#c7d2fe; color:#1e3a8a }
#saveStatus.saving{ background:#fff7ed; border-color:#fed7aa; color:#9a3412 }
#saveStatus.error{ background:#fee2e2; border-color:#fecaca; color:#991b1b }
/* build-only generic hidden default; toggled by applyBuildModeUI */
.build-only{ display:none; }
</style>

</style>
</head>
<body>
  <div class="wm"><img src="${logo}" alt="Watermark"></div>
  <div class="wrap">
    <section class="cover"><div class="cover__panel">
      <div class="brand"><div class="brand__logo"><img src="${logo}" alt="Brand"></div>
        <div><h1 class="title">Retail Audit Report</h1><div class="sub"><b>Date:</b> ${h(d)}</div></div></div>
      <div class="score"><div class="score__pct" id="overallPct">0%</div><div class="score__band" id="overallBand"></div></div>
      <div class="meta-grid"><div class="meta-card"><b>Store:</b> ${h(store)}</div><div class="meta-card"><b>Auditor:</b> ${h(aud)}</div><div class="meta-card"><b>Manager:</b> ${h(man)}</div></div>
      <div class="tools"><button class='btn' id='btnPrint' style='display:none'>Print</button><button class="btn" id="btnToggleAllQ">All questions</button><button class="btn" id="btnClearExport" style='display:none'>Clear saved data</button></div>
      <div class="tiles" id="tiles"></div>
      <div class="cover-ap"><h2 id="ap_section" style="margin:0 0 8px">Action Plan</h2><div class="meta">Open/Close items to update the score instantly.</div><div id="apHost"></div></div>
      <div class="cover-ap"><h2 style="margin:12px 0 8px">Comments</h2><div id="commentHost"></div></div>
    </div></section>
    <section id="allQ"><h2>All answered questions</h2><div id="allQHost" class="meta">${allQHtml}</div></section>
  </div>
  <div id="saveToast" style="position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:rgba(20,20,20,.85);color:#fff;padding:10px 14px;border-radius:999px;font-weight:800;font-size:14px;opacity:0;pointer-events:none;transition:opacity .25s;z-index:9999">Saved ✓</div>
  <script id="payload" type="application/json">${DATA_JSON}</`+`script>
  <script>(function(){
    var RAW=document.getElementById('payload'); if(!RAW) return; var DATA=[]; try{ DATA=JSON.parse(RAW.textContent||'[]'); }catch(_){ DATA=[]; }
    var STORAGE_KEY='${storageKey}';
    function band(p){ return p>=95?{l:'Excellent',c:'green'}: p>=90?{l:'Good Work',c:'green'}: p>=80?{l:'Pass',c:'#ff9800'} : {l:'Action Needed',c:'red'}; }
    function scored(it){ return ((it.answer==='Pass' && (!it.apEnabled || it.apStatus!=='Open')) || (it.answer==='Fail' && it.apEnabled && it.apStatus==='Closed')); }
    function summary(){ var m=new Map(),A=0,S=0; DATA.forEach(function(it){ if(it.answer==='Pass' || it.answer==='Fail'){ A++; if(scored(it)) S++; if(!m.has(it.sector)) m.set(it.sector,{a:0,s:0}); var v=m.get(it.sector); v.a++; if(scored(it)) v.s++; m.set(it.sector,v);} }); var rows=[]; m.forEach(function(v,k){ rows.push({s:k,p:v.a?Math.round(100*v.s/v.a):0}); }); return {pct:A?Math.round(100*S/A):0, rows:rows}; }
    function mk(t,a,txt){ var n=document.createElement(t); if(a){ for(var k in a){ if(k==='class') n.className=a[k]; else n.setAttribute(k,a[k]); } } if(txt!=null) n.textContent=txt; return n; }
    function clear(n){ while(n.firstChild) n.removeChild(n.firstChild); }
    function toastSaved(){ var t=document.getElementById('saveToast'); if(!t) return; t.style.opacity='1'; clearTimeout(toastSaved._t); toastSaved._t=setTimeout(function(){ t.style.opacity='0'; }, 1200); }

    function renderHeader(){ var s=summary(); var o=document.getElementById('overallPct'); if(o) o.textContent=s.pct+'%'; var bd=document.getElementById('overallBand'); if(bd){ var b=band(s.pct); bd.textContent=b.l; bd.style.color=b.c; } var tiles=document.getElementById('tiles'); if(tiles){ clear(tiles); s.rows.forEach(function(r){ var b=band(r.p); var card=mk('div',{'class':'tile'}); var t1=mk('div',null,r.s); t1.style.cssText='font-weight:700;color:#374151'; card.appendChild(t1); var t2=mk('div',null,r.p+'%'); t2.style.cssText='font-size:28px;font-weight:900'; card.appendChild(t2); var t3=mk('div',null,b.l); t3.style.cssText='font-size:13px;color:'+b.c; card.appendChild(t3); tiles.appendChild(card); }); } }

    // STRICT: only apEnabled === true in AP
    function renderAP(){ var host=document.getElementById('apHost'); if(!host) return; var items = DATA.filter(function(x){ return x.apEnabled === true; }); var H=document.getElementById('ap_section'); if(H) H.textContent='Action Plan ('+items.length+')'; clear(host); if(!items.length){ host.appendChild(mk('div',{'class':'meta'},'No Action Plan items.')); return; } var wrap=mk('div',{'class':'ap-cards'}); items.forEach(function(a){ var card=mk('div',{'class':'ap-card','data-qid':a.id}); var head=mk('div',{'class':'ap-card__head'}); var headLeft=mk('div',{'class':'ap-head__left'}); headLeft.appendChild(mk('div',{'class':'ap-card__cat'}, (a.category||''))); headLeft.appendChild(mk('div',{'class':'ap-card__q'}, (a.text||''))); head.appendChild(headLeft); var img=(a.photoThumb? mk('img',{'class':'ap-thumb','src':a.photoThumb,'alt':'Photo'}) : null); if(img) head.appendChild(img); card.appendChild(head); var body=mk('div',{'class':'ap-card__body'}); var d1=mk('div',{'class':'ap-field'}); d1.appendChild(mk('div',{'class':'ap-label'},'Description')); d1.appendChild(mk('div',{'class':'ap-val'}, (a.apDesc||''))); body.appendChild(d1); var d2=mk('div',{'class':'ap-field'}); d2.appendChild(mk('div',{'class':'ap-label'},'Person')); d2.appendChild(mk('div',{'class':'ap-val'}, (a.apPerson||''))); body.appendChild(d2); var d3=mk('div',{'class':'ap-field'}); d3.appendChild(mk('div',{'class':'ap-label'},'Action')); d3.appendChild(mk('div',{'class':'ap-val'}, (a.apAction||''))); var how=mk('div',{'class':'how-wrap'}); how.appendChild(mk('div',{'class':'how-label'},'How action was closed')); var ta=document.createElement('textarea'); ta.setAttribute('class','apx-howclosed'); ta.setAttribute('data-qid',a.id); ta.setAttribute('placeholder','Briefly describe how the action was closed'); ta.value=a.apHowClosed||''; if(a.apStatus==='Closed'){ ta.disabled=true; } else { ta.removeAttribute('disabled'); } ta.addEventListener('input', function(){ var qid=this.getAttribute('data-qid'); var entry=DATA.find(function(x){return x.id===qid;}); if(entry){ entry.apHowClosed=this.value; persist(); } }); how.appendChild(ta); d3.appendChild(how); body.appendChild(d3); card.appendChild(body); var foot=mk('div',{'class':'ap-card__foot'}); var btn=mk('button',{'class':'apx-toggle '+(a.apStatus==='Closed'?'closed':'open'),'data-qid':a.id}, (a.apStatus||'Open')); foot.appendChild(btn); var cd=mk('div',{'class':'ap-closed'}); cd.appendChild(mk('span',{'class':'ap-label'},'Closed on')); cd.appendChild(mk('span',{'class':'apx-closedOn'}, (a.apClosedOn ? a.apClosedOn : (a.apStatus==='Closed'? new Date().toISOString().slice(0,10): '')) )); foot.appendChild(cd); card.appendChild(foot); wrap.appendChild(card); }); host.appendChild(wrap); }

    function renderComments(){ var host=document.getElementById('commentHost'); if(!host) return; clear(host); var items=DATA.filter(function(x){ return (x.apComment && x.apComment.trim()) || x.extraPhotoThumb || (x.extraComment && x.extraComment.trim()); }); if(!items.length){ host.appendChild(mk('div',{'class':'meta'},'No comments.')); return; }
      var bySector=new Map(); items.forEach(function(it){ if(!bySector.has(it.sector)) bySector.set(it.sector, new Map()); var byCat=bySector.get(it.sector); if(!byCat.has(it.category)) byCat.set(it.category, []); byCat.get(it.category).push(it); });
      var wrap=mk('div',{'class':'c-cards'});
      bySector.forEach(function(cmap, sector){ cmap.forEach(function(list, cat){ list.forEach(function(c){ var card=mk('div',{'class':'c-card'}); card.appendChild(mk('div',{'class':'c-card__head'}, sector+' / '+cat)); card.appendChild(mk('div',{'class':'c-card__q'}, c.text||'')); card.appendChild(mk('div',{'class':'ap-val'}, c.apComment||'')); if(c.photoThumb){ var ph=document.createElement('div'); var im=document.createElement('img'); im.src=c.photoThumb; im.className='ap-thumb'; ph.appendChild(im); card.appendChild(ph);} 
      if(c.extraComment && c.extraComment.trim()){ card.appendChild(mk('div',{'class':'ap-val'}, c.extraComment)); }
 wrap.appendChild(card); }); }); });
      host.appendChild(wrap);
    }

    function persist(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(DATA)); toastSaved(); }catch(e){} }
    try{ var draft=localStorage.getItem(STORAGE_KEY); if(draft){ var incoming=JSON.parse(draft); var byId=new Map(); DATA.forEach(function(x){ byId.set(x.id,x); }); incoming.forEach(function(nx){ var cur=byId.get(nx.id); if(cur){ for(var k in nx){ cur[k]=nx[k]; } } }); } }catch(_){ }
    try{ renderHeader(); renderAP(); renderComments(); }catch(_){ }

    document.addEventListener('click', function(e){ var btn=e.target && e.target.closest? e.target.closest('.apx-toggle') : null; if(!btn) return; var card=btn.closest('.ap-card'); var qid=btn.getAttribute('data-qid'); var entry=DATA.find(function(x){ return x.id===qid; }); if(!entry) return; var next=(entry.apStatus==='Closed'?'Open':'Closed'); entry.apEnabled=true; entry.apStatus=next; var cell=card?card.querySelector('.apx-closedOn'):null; if(next==='Closed'){ if(cell && !cell.textContent.trim()) cell.textContent=new Date().toISOString().slice(0,10); if(!entry.apClosedOn){ entry.apClosedOn = cell?cell.textContent : new Date().toISOString().slice(0,10); } } else { if(cell) cell.textContent=''; entry.apClosedOn=''; } btn.classList.toggle('closed', next==='Closed'); btn.classList.toggle('open', next!=='Closed'); btn.textContent=next; renderHeader(); persist(); });

    var btn=document.getElementById('btnToggleAllQ'); var bx=document.getElementById('btnClearExport'); if(bx){ bx.addEventListener('click', function(){ try{
        var keys=[]; for(var i=0;i<localStorage.length;i++){ var k=localStorage.key(i); if(k && k.indexOf('birds_export_')===0) keys.push(k); }
        keys.forEach(function(k){ try{ localStorage.removeItem(k); }catch(e){} });
      }catch(e){}; toastSaved && toastSaved(); setTimeout(function(){ location.reload(); }, 150); }); } if(btn){ btn.addEventListener('click', function(){ var s=document.getElementById('allQ'); s.style.display = s.style.display!=='none' ? 'none':'block'; }); }
  
var p=document.getElementById('btnPrint'); if(p){ p.addEventListener('click', function(){ window.print(); }); }
})();
  </`+`script>`;

  var blob=new Blob([html],{type:'text/html;charset=utf-8'});
  var a=document.createElement('a'); var safe=(state.meta.store||'audit').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  a.href=URL.createObjectURL(blob); a.download='audit-report-'+(safe||'report')+'.html'; document.body.appendChild(a); a.click(); a.remove();
}
// ===== New CLEAR ANSWERS ONLY function =====
function clearAnswersOnly() {
    if (!confirm("Clear all answers, photos and action plans? Your question bank and text edits will remain.")) 
        return;

    // Clear meta fields
    state.meta = { store: "", date: "", auditor: "", manager: "" };

    // Clear answer, action and photos for every question
    for (const sid in state.sectors) {
        const sec = state.sectors[sid];
        sec.categories.forEach(function(cat) {
            cat.questions.forEach(function(q) {
                q.answer = null;
                q.photo = null;
                q.photoThumb = null;
                q.action = null;
 q.comment = '';
 });
 });
    }

    quickSave();
    render();
}
  // ===== Storage & lifecycle =====
  function currentWorkKey(){ var s=$('#storeName').value.trim()||'store'; var d=$('#auditDate').value||'date'; return WORK_KEY_BASE+'__'+s.toLowerCase().replace(/[^a-z0-9]+/g,'-')+'__'+d; }
  function saveWorkingCopy(){ try{ setSaveStatus('saving'); const ok = setSaveStatus('saving'); var __ok = slimSaveToLocalStorage(currentWorkKey(), state); setSaveStatus(__ok?'saved':'error'); setSaveStatus(ok?'saved':'error'); if(!ok) throw new Error('Quota exceeded'); toast('Saved ✓'); }catch(e){ alert('Save failed: '+e.message); } }
  function quickSave(){ try{ setSaveStatus('saving'); var __ok = slimSaveToLocalStorage(currentWorkKey(), state); setSaveStatus(__ok?'saved':'error'); }catch(e){} }
  function clearWorkingCopy(){ if(!confirm('Clear all progress on this page? This cannot be undone.')) return; state.meta={store:'',date:'',auditor:'',manager:''}; state.sectors={}; try{ localStorage.removeItem(currentWorkKey()); }catch(e){} render(); }
  function toast(msg){ var t=document.getElementById('saveToast'); t.textContent=msg||'Saved ✓'; t.style.opacity='1'; clearTimeout(toast._t); toast._t=setTimeout(function(){ t.style.opacity='0'; }, 1200); }

  // ===== Download helper =====
  function download(bytes,name,type){ var blob=(bytes instanceof Blob)?bytes:new Blob([bytes],{type:type}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); }
  function safeName(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
  function safeScriptJSON(obj){ return JSON.stringify(obj).replace(/</g,'\\u003c').replace(/\u2028/g,'\\u2028').replace(/\u2029/g,'\\u2029'); }

  
// --- Begin: Slim-save helpers (avoid quota issues) ---
function cloneWithoutHeavyBits(src) {
  const s = JSON.parse(JSON.stringify(src));
  if (s && s.sectors) {
    for (const sid in s.sectors) {
      const sec = s.sectors[sid];
      (sec.categories || []).forEach(cat => {
        (cat.questions || []).forEach(q => {
          if ('photo' in q) q.photo = null;
          if ('extraPhoto' in q) q.extraPhoto = null;
        });
      });
    }
  }
  return s;
}
function slimSaveToLocalStorage(key, fullState) {
  try { const slim = cloneWithoutHeavyBits(fullState); localStorage.setItem(key, JSON.stringify(slim)); return true; } catch(e){ return false; }
}
function purgeAllWorkingCopies(){ try{ const KEYS=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(!k) continue; if(k.indexOf(WORK_KEY_BASE+'__')===0 || k.indexOf('birds_export_')===0){ KEYS.push(k);} } KEYS.forEach(k=>{ try{ localStorage.removeItem(k);}catch(_){}}); }catch(_){} }
// --- End: Slim-save helpers ---

// ===== Loading seeds (manual upload) =====
  function buildStateFromSeed(seed){
    var sectors = (seed && seed.sectors) ? seed.sectors : (seed || {});
    var next={};
    for(var key in sectors){ var sec=sectors[key]; var cats=[]; (sec.categories||[]).forEach(function(cat){ var qs=[]; (cat.questions||[]).forEach(function(q){ var text = (typeof q==='string')? q : (q && q.text ? q.text : '');
var weight = (typeof q==='object' && (q.weight != null || q.weighting != null)) ? Number(q.weight ?? q.weighting) || 1 : 1;
qs.push({ id: (q && q.id) ? q.id : uid(), text:text, weight: weight, answer:null, photo:null, photoThumb:null, action:null, comment:'' }); }); cats.push({ id:uid(), name:cat.name, questions:qs }); }); next[key] = { title: sec.title, categories: cats }; }
    state.sectors=next;
  }

  // ===== Listeners =====
  document.getElementById('exportBtn').addEventListener('click', exportHTML);
  document.getElementById('btnExportActionCsv').addEventListener('click', exportActionCSV);
 var __btnOpenDrawer=document.getElementById('btnOpenDrawer'); if(__btnOpenDrawer){ __btnOpenDrawer.addEventListener('click', openDrawer); } var __btnCloseDrawer=document.getElementById('btnCloseDrawer'); if(__btnCloseDrawer){ __btnCloseDrawer.addEventListener('click', closeDrawer); }
  document.getElementById('saveBtn').addEventListener('click', saveWorkingCopy);
  document.getElementById('clearBtn').addEventListener('click', clearAnswersOnly);
  document.getElementById('apFilterStatus').addEventListener('change', renderActionPlan);
 document.getElementById('btnClearCache').addEventListener('click', function(){ if(!confirm('Clear saved drafts and exported autosaves from this browser?')) return; purgeAllWorkingCopies(); toast('Cache cleared ✓'); });

var __mt = document.getElementById('modeToggle');
if(__mt){
  __mt.addEventListener('change', function(){ BUILD_MODE=this.checked; applyBuildModeUI(); render(); });
}
applyBuildModeUI();


  document.getElementById('logoPicker').addEventListener('change', function(e){ var f=e.target.files && e.target.files[0]; if(!f) return; var r=new FileReader(); r.onload=function(){ state.watermark=r.result; try{ localStorage.setItem('audit_watermark_v2', r.result); }catch(e){} applyWatermarkToPage(); applyBuildModeUI(); quickSave(); }; r.readAsDataURL(f); });

  document.getElementById('saveTemplateBtn').addEventListener('click',exportJSON);
 document.getElementById('seedPicker').addEventListener('change', function(e){ var f=e.target.files && e.target.files[0]; if(!f) return; var fr=new FileReader(); fr.onload=function(){ try{ var seed=JSON.parse(fr.result); purgeAllWorkingCopies(); buildStateFromSeed(seed); nav={level:'sectors',sectorId:null,categoryId:null}; render(); toast('Questions loaded ✓'); }catch(err){ alert('Invalid JSON: '+err.message); } }; fr.readAsText(f, 'utf-8'); });

  ['#storeName','#auditDate','#auditorName','#storeManager'].forEach(function(sel){ document.querySelector(sel).addEventListener('input', function(){ state.meta.store=$('#storeName').value.trim(); state.meta.date=$('#auditDate').value; state.meta.auditor=$('#auditorName').value.trim(); state.meta.manager=$('#storeManager').value.trim(); quickSave(); }); });

  // Try restore from last working key (if any)
  try{ var keys=[]; for(var i=0;i<localStorage.length;i++){ var k=localStorage.key(i); if(k && k.indexOf(WORK_KEY_BASE+'__')===0) keys.push(k); } keys.sort(); if(keys.length){ var last=localStorage.getItem(keys[keys.length-1]); if(last){ var draft=JSON.parse(last); if(draft && draft.sectors){ state=draft; } } }
  }catch(e){}

  render();
  </script>

<!-- Mobile bottom action bar -->
<div class="mbar" role="region" aria-label="Quick actions">
  <button class="btn ghost" type="button" onclick="saveWorkingCopy()">Save</button>
  <button class="btn ghost" type="button" onclick="exportActionCSV()">CSV</button>
  <button class="btn green" type="button" onclick="exportHTML()">Export</button>
  <button class="btn ghost" type="button" id="btnOpenDrawer">Sectors</button>
  <button class="btn" type="button" onclick="window.scrollTo({top:0,behavior:'smooth'})">Top</button>
</div>

<script>
(function(){
  // Highlight selected answer chip without changing existing app logic
  function syncAnswerChips(root){
    (root||document).querySelectorAll('.answers').forEach(function(group){
      var checked = group.querySelector('input[type=radio]:checked');
      group.querySelectorAll('label').forEach(function(l){ l.classList.toggle('sel', checked && l.contains(checked)); });
    });
  }
  document.addEventListener('change', function(e){
    if(e.target && e.target.matches('.answers input[type=radio]')){
      var box = e.target.closest('.answers');
      if(!box) return; box.querySelectorAll('label').forEach(function(l){ l.classList.toggle('sel', l.contains(e.target) && e.target.checked); });
    }
  });
  // Initialize on load and periodically (after render cycles)
  document.addEventListener('DOMContentLoaded', function(){
    syncAnswerChips(document);
    setTimeout(syncAnswerChips, 150);
    setTimeout(syncAnswerChips, 400);
  });
})();
</script>

<!-- Floating Score Bubble -->
<div id="floatingScore" aria-live="polite" style="position:fixed;right:12px;bottom:92px;z-index:60;background:rgba(17,24,39,.92);color:#fff;border-radius:999px;padding:10px 14px;font-weight:800;font-size:14px;box-shadow:0 6px 18px rgba(0,0,0,.22);display:none">Score: 0% • Actions: 0</div>

<!-- Sector Bottom Drawer -->
<div id="sectorDrawer" style="position:fixed;left:0;right:0;bottom:-70vh;height:60vh;background:var(--card);border-top:1px solid var(--border);box-shadow:0 -12px 32px rgba(0,0,0,.18);border-top-left-radius:18px;border-top-right-radius:18px;z-index:70;transition:bottom .25s ease-out;padding:12px 14px">
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
    <b style="font-size:16px">Jump to sector</b>
    <button id="btnCloseDrawer" class="btn small" style="margin-left:auto">Close</button>
  </div>
  <div id="sectorDrawerList" style="display:grid;gap:8px;grid-template-columns:repeat(2,minmax(0,1fr))"></div>
</div>

</body>
</html>

