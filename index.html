<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Birds Audit — Retail Audit Modular</title>
  <meta name="theme-color" content="#47b39d"/>
  <style>
    :root{
      --bg:#f6faf8; --card:#ffffff; --ink:#1f2937; --muted:#667085; --border:#e6eae7;
      --brand:#0ea5e9; --accent:#47b39d; --accent2:#10b981; --ring:#e5e7eb;
      --touch: 44px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,-apple-system,sans-serif;padding-bottom:84px}
    header{position:sticky;top:0;z-index:50;background:#111827;color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    header h1{font-size:18px;margin:0;display:flex;gap:10px;align-items:center}
    .brand-chip{width:28px;height:28px;border-radius:8px;background:#fff;display:grid;place-items:center;overflow:hidden}
    .brand-chip img{max-width:100%}
    .actions{display:flex;gap:8px;margin-left:auto}
    .btn{appearance:none;border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;color:#fff;background:var(--accent);min-height:var(--touch)}
    .btn.ghost{background:transparent;border:2px solid #fff}
    .wrap{max-width:1120px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(0,0,0,.06);margin-bottom:12px}
    .scorecard{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
    .donut{width:120px;height:120px}
    .stat b{font-size:1.25rem;display:block}
    .tiles{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    .tile{background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px;cursor:pointer;transition:background .2s}
    .tile:hover{background:#f3f4f6}
    .q{border-top:1px dashed var(--border);padding-top:12px;margin-top:12px}
    .answers{display:flex;gap:10px;margin-top:8px}
    .answers label{padding:10px 16px;border:2px solid var(--border);border-radius:12px;cursor:pointer;font-weight:700}
    .answers input{display:none}
    .answers label:has(input:checked){background:var(--brand);color:#fff;border-color:var(--brand)}
    .crumbs{margin:10px 0;display:flex;gap:8px;color:var(--brand);font-weight:700;cursor:pointer}
    #apTable{width:100%;border-collapse:collapse}
    #apTable th,#apTable td{border:1px solid var(--border);padding:8px;text-align:left;font-size:13px}
    .thumb{width:96px;height:96px;border-radius:8px;object-fit:cover;margin-top:8px;display:none}
    @media (prefers-color-scheme: dark){
      :root{--bg:#0b1411;--card:#0f1a16;--ink:#f1f5f9;--border:#1f2b25}
      body{background:var(--bg);color:var(--ink)}
    }
  </style>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <header>
    <h1><div class="brand-chip"><img id="hdrLogo"></div> Birds Audit</h1>
    <div class="actions">
      <label class="btn ghost">Load JSON <input id="seedPicker" type="file" accept="application/json" hidden></label>
      <button class="btn ghost" id="saveBtn">Save State</button>
      <button class="btn" style="background:var(--accent2)" id="exportBtn">Export Report</button>
    </div>
  </header>
  <div class="wrap">
    <section class="card scorecard">
      <svg class="donut" viewBox="0 0 42 42">
        <circle cx="21" cy="21" r="18" fill="transparent" stroke="var(--ring)" stroke-width="6"></circle>
        <circle id="donutVal" cx="21" cy="21" r="18" fill="transparent" stroke="var(--brand)" stroke-width="6" stroke-dasharray="0 113" transform="rotate(-90 21 21)"></circle>
        <text id="donutText" x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="8" font-weight="800">0%</text>
      </svg>
      <div class="stat"><span class="muted">Answered</span><b id="statAnswered">0</b></div>
      <div class="stat"><span class="muted">Open Actions</span><b id="statActions">0</b></div>
      <div class="stat"><span class="muted">Score</span><b id="statScore">0%</b></div>
    </section>
    <div class="crumbs" id="crumbs" style="display:none">← Back to Sectors</div>
    <main id="pane" class="card">
      <div class="hint">Upload your Question Set (.json) to begin the audit.</div>
    </main>
    <section class="card">
      <h3>Action Plan Summary</h3>
      <table id="apTable">
        <thead><tr><th>Category</th><th>Issue Description</th><th>Action Required</th><th>Status</th></tr></thead>
        <tbody id="apBody"></tbody>
      </table>
    </section>
  </div>
  <script>
    if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }
    let state = { sectors: {}, meta: {} };
    const $ = s => document.querySelector(s);

    // Placeholder Logo
    $('#hdrLogo').src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="50" cy="50" r="40" fill="%2347b39d"/></svg>';

    $('#seedPicker').onchange = e => {
      const reader = new FileReader();
      reader.onload = ev => { 
        state.sectors = JSON.parse(ev.target.result); 
        renderSectors(); 
      };
      reader.readAsText(e.target.files[0]);
    };

    function renderSectors() {
      $('#crumbs').style.display = 'none';
      const pane = $('#pane');
      pane.innerHTML = '<div class="tiles"></div>';
      Object.keys(state.sectors).forEach(id => {
        const sec = state.sectors[id];
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.innerHTML = `<h3>${sec.title}</h3><p>Manage categories & questions</p>`;
        tile.onclick = () => renderCategories(id);
        $('.tiles').appendChild(tile);
      });
      updateStats();
    }

    function renderCategories(sectorId) {
      $('#crumbs').style.display = 'block';
      const pane = $('#pane');
      const sector = state.sectors[sectorId];
      pane.innerHTML = `<h2>${sector.title}</h2>`;
      sector.categories.forEach(cat => {
        const div = document.createElement('div');
        div.innerHTML = `<h4 style="margin-top:20px; border-bottom:1px solid var(--border)">${cat.name}</h4>`;
        cat.questions.forEach(q => div.appendChild(createQuestionEl(q, cat.name)));
        pane.appendChild(div);
      });
    }

    function createQuestionEl(q, catName) {
      const wrap = document.createElement('div');
      wrap.className = 'q';
      wrap.innerHTML = `
        <div style="font-weight:600">${q.text}</div>
        <div class="answers">
          <label><input type="radio" name="${q.id}" value="Pass" ${q.answer==='Pass'?'checked':''}> Pass</label>
          <label><input type="radio" name="${q.id}" value="Fail" ${q.answer==='Fail'?'checked':''}> Fail</label>
          <label><input type="radio" name="${q.id}" value="NA" ${q.answer==='NA'?'checked':''}> N/A</label>
        </div>
        <div id="ap_${q.id}" style="display:${q.answer==='Fail'?'block':'none'}; margin-top:10px; background:#fff5f5; padding:10px; border-radius:8px; border:1px solid #feb2b2">
           <textarea placeholder="Describe the action needed..." style="width:100%; border:1px solid #fecaca; border-radius:4px">${q.action || ''}</textarea>
        </div>
      `;
      wrap.querySelectorAll('input').forEach(i => {
        i.onchange = () => { 
          q.answer = i.value; 
          wrap.querySelector(`#ap_${q.id}`).style.display = i.value === 'Fail' ? 'block' : 'none';
          updateStats(); 
          renderActionPlan(); 
        };
      });
      wrap.querySelector('textarea').oninput = (e) => { q.action = e.target.value; renderActionPlan(); };
      return wrap;
    }

    function updateStats() {
      let answered = 0, total = 0, passed = 0, actions = 0;
      Object.values(state.sectors).forEach(s => s.categories.forEach(c => c.questions.forEach(q => {
        if(q.answer && q.answer !== 'NA') {
          answered++;
          if(q.answer === 'Pass') passed++;
          if(q.answer === 'Fail') actions++;
        }
        if(q.answer !== 'NA') total++;
      })));
      const score = total ? Math.round((passed/total)*100) : 0;
      $('#statAnswered').innerText = answered;
      $('#statActions').innerText = actions;
      $('#statScore').innerText = score + '%';
      $('#donutText').textContent = score + '%';
      $('#donutVal').style.strokeDasharray = `${(score/100)*113} 113`;
    }

    function renderActionPlan() {
      const body = $('#apBody');
      body.innerHTML = '';
      Object.values(state.sectors).forEach(s => s.categories.forEach(c => c.questions.forEach(q => {
        if(q.answer === 'Fail') {
          const row = body.insertRow();
          row.innerHTML = `<td>${c.name}</td><td>${q.text}</td><td>${q.action || 'No action specified'}</td><td><b style="color:#e53e3e">OPEN</b></td>`;
        }
      })));
    }

    $('#crumbs').onclick = renderSectors;
    $('#saveBtn').onclick = () => { localStorage.setItem('audit_data_backup', JSON.stringify(state)); alert('Progress Saved Locally'); };
    $('#exportBtn').onclick = () => window.print();
  </script>
</body>
</html>
